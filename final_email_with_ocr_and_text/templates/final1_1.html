<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Automation Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='aug18.1.css') }}">
    <style>
        .loader {
            width: 40px;
            aspect-ratio: 1;
            --c: linear-gradient(#000 0 0);
            --r1: radial-gradient(farthest-side at bottom,#000 93%,#0000);
            --r2: radial-gradient(farthest-side at top   ,#000 93%,#0000);
            background: 
                var(--c) ,var(--r1),var(--r2),
                var(--c) ,var(--r1),var(--r2),
                var(--c) ,var(--r1),var(--r2);
            background-repeat: no-repeat;
            animation: l2 1s infinite alternate;
        }
        @keyframes l2 {
            0%,25% {
                background-size: 8px 0,8px 4px,8px 4px,8px 0,8px 4px,8px 4px,8px 0,8px 4px,8px 4px;
                background-position: 0 50%,0 calc(50% - 2px),0 calc(50% + 2px),50% 50%,50% calc(50% - 2px),50% calc(50% + 2px),100% 50%,100% calc(50% - 2px),100% calc(50% + 2px);
            }
            50% {
                background-size: 8px 100%,8px 4px,8px 4px,8px 0,8px 4px,8px 4px,8px 0,8px 4px,8px 4px;
                background-position: 0 50%,0 calc(0% - 2px),0 calc(100% + 2px),50% 50%,50% calc(50% - 2px),50% calc(100% + 2px),100% 50%,100% calc(50% - 2px),100% calc(50% + 2px);
            }
            75% {
                background-size: 8px 100%,8px 4px,8px 4px,8px 100%,8px 4px,8px 4px,8px 0,8px 4px,8px 4px;
                background-position: 0 50%,0 calc(0% - 2px),0 calc(100% + 2px),50% 50%,50% calc(0% - 2px),50% calc(100% + 2px),100% 50%,100% calc(50% - 2px),100% calc(100% + 2px);
            }
            95%,100% {
                background-size: 8px 100%,8px 4px, 8px 4px,8px 100%,8px 4px,8px 4px,8px 100%,8px 4px,8px 4px;
                background-position: 0 50%,0 calc(0% - 2px),0 calc(100% + 2px),50% 50%,50% calc(0% - 2px),50% calc(100% + 2px),100% 50%,100% calc(0% - 2px),100% calc(100% + 2px);
            }
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>

    <div class="container">
        <h1>Email Automation Dashboard</h1>
        
        <div class="dashboard">
            <div class="kpi-card">
                <h2>Total Unseen Mails</h2>
                <p id="unseen-mails">Loading...</p>
            </div>
            <div class="kpi-card">
                <h2>Pending Responses</h2>
                <p id="pending-responses">Loading...</p>
            </div>
            <div class="kpi-card">
                <h2>Completed Responses</h2>
                <p id="completed-responses">Loading...</p>
            </div>
            <div class="kpi-card">
                <h2>Error Log</h2>
                <ul id="error-log">Loading...</ul>
            </div>
        </div>

        <!-- New Button to Fetch Unseen Emails -->
        <div class="fetch-unseen-emails centered-container">
            <button id="fetch-emails-btn">Fetch Unseen Emails</button>
            <!-- No loader here; it will be added dynamically -->
        </div>

        <div class="email-details-section">
            <h2>Fetched Email Details</h2>
            <div class="filters">
                <input type="text" id="filter-sender" placeholder="Filter by Sender">
                <input type="text" id="filter-subject" placeholder="Filter by Subject">
                <button id="apply-filters">Apply Filters</button>
            </div>

            <div id="email-details" class="email-details">
                <!-- Email details will be inserted here dynamically -->
            </div>

            <div class="pagination centered-container">
                <button id="prev-page" disabled>Previous</button>
                <span id="page-info">Page 1</span>
                <button id="next-page">Next</button>
            </div>
        </div>

        <!-- Button to Run Main.py -->
        <div class="run-main centered-container">
            <button id="run-main-btn">Run Email Workflow</button>
            <!-- No loader here; it will be added dynamically -->
        </div>

        <!-- New section to display Response Details -->
        <div class="response-details-section">
            <h2>Response Details</h2>
            <div id="response-details" class="response-details">
                <!-- Response details will be inserted here dynamically -->
            </div>
        </div>
    </div>

    <div id="email-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div id="modal-email-content">Loading...</div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;

        function loadDashboardData() {
            $.getJSON('/api/dashboard-data', function(data) {
                $('#unseen-mails').text(data.unseen_mails);
                $('#pending-responses').text(data.pending_responses);
                $('#completed-responses').text(data.completed_responses);
                
                let errorLogHtml = '';
                data.error_log.forEach(function(error) {
                    errorLogHtml += `<li>${error}</li>`;
                });
                $('#error-log').html(errorLogHtml);

                loadEmails(currentPage);
            });
        }

        function loadEmails(page) {
            const senderFilter = $('#filter-sender').val();
            const subjectFilter = $('#filter-subject').val();
            
            $.getJSON(`/api/emails?page=${page}&sender=${senderFilter}&subject=${subjectFilter}`, function(data) {
                let emailDetailsHtml = '';
                data.emails.forEach(function(email) {
                    let attachmentsHtml = '';
                    if (email.attachment_count > 0) {
                        attachmentsHtml = `
                            <p><strong>Attachments:</strong> ${email.attachment_count} file(s)</p>
                            <ul>
                                ${email.attachment_types.map(type => `<li>${type}</li>`).join('')}
                            </ul>
                        `;
                    } else {
                        attachmentsHtml = `<p><strong>Attachments:</strong> None</p>`;
                    }

                    emailDetailsHtml += `
                        <div class="email-card" data-email-id="${email.id}">
                            <p><strong>Sender:</strong> ${email.sender}</p>
                            <p><strong>Subject:</strong> ${email.subject}</p>
                            <p><strong>Received:</strong> ${email.received_date}</p>
                            <p><strong>Content Preview:</strong> ${email.content_preview}</p>
                            ${attachmentsHtml}
                        </div>
                    `;
                });
                $('#email-details').html(emailDetailsHtml);
                totalPages = data.total_pages;
                currentPage = data.current_page;
                updatePaginationControls();
            });
        }

        // Load response details after running the workflow
        function loadResponseDetails() {
            $.getJSON('/api/response-details', function(data) {
                if (data.error) {
                    $('#response-details').html(`<p>${data.error}</p>`);
                    return;
                }
        
                let responseDetailsHtml = '';
                data.response_details.forEach(function(detail) {
                    responseDetailsHtml += `
                        <div class="response-detail-card">
                            <p><strong>Email ID:</strong> ${detail.email_id}</p>
                            <p><strong>Response Status:</strong> ${detail.status}</p>
                            <p><strong>Generated Response:</strong></p>
                            <pre>${detail.generated_response}</pre>
                            <p><strong>Attachment Path:</strong> ${detail.attachment_path}</p>
                        </div>
                    `;
                });
                $('#response-details').html(responseDetailsHtml);
            });
        }

        function updatePaginationControls() {
            $('#prev-page').prop('disabled', currentPage === 1);
            $('#next-page').prop('disabled', currentPage === totalPages);
            $('#page-info').text(`Page ${currentPage} of ${totalPages}`);
        }

        $(document).ready(function() {
            loadDashboardData();

            $('#prev-page').on('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    loadEmails(currentPage);
                }
            });

            $('#next-page').on('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadEmails(currentPage);
                }
            });

            $('#apply-filters').on('click', function() {
                currentPage = 1;
                loadEmails(currentPage);
            });

            $('#fetch-emails-btn').on('click', function() {
                $('#fetch-emails-btn').after('<div class="loader"></div>');
                $.post('/api/fetch-emails', function(response) {
                    $('.loader').remove();  // Remove loader after the process completes
                    if (response.success) {
                        loadDashboardData();
                    } else {
                        alert('Error fetching emails: ' + response.error);
                    }
                });
            });

            $('#run-main-btn').on('click', function() {
                $('#run-main-btn').after('<div class="loader"></div>');
                $.post('/api/run-main', function(response) {
                    $('.loader').remove();  // Remove loader after the process completes
                    if (response.success) {
                        loadResponseDetails();
                    } else {
                        alert('Error running workflow: ' + response.error);
                    }
                });
            });

            $('#email-details').on('click', '.email-card', function() {
                const emailId = $(this).data('email-id');
                $.getJSON(`/api/email-content/${emailId}`, function(data) {
                    $('#modal-email-content').text(data.content);
                    $('#email-modal').show();
                });
            });

            $('.close').on('click', function() {
                $('#email-modal').hide();
            });
        });
    </script>
</body>
</html>
